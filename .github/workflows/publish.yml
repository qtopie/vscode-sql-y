name: Publish VS Code Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Optional explicit version to publish (e.g. 1.2.3)'
        required: false

jobs:
  build-and-publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set package.json version from Git tag or workflow input
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          else
            echo "No tag or input version provided â€” keeping existing package.json version"
            exit 0
          fi
          echo "Setting package.json version -> $VERSION"
          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json'));p.version=process.argv[1];fs.writeFileSync('package.json',JSON.stringify(p,null,2));" "$VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build / package (production)
        run: npm run package

      - name: Create .vsceignore if missing
        run: |
          if [ ! -f .vsceignore ]; then
            printf "node_modules\n.vscode\n.vscode-test\n.git\n" > .vsceignore
          fi

      - name: Package extension to VSIX
        run: npx vsce package -o extension.vsix

      - name: Publish to Visual Studio Marketplace
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
        run: |
          if [ -z "$VSCE_TOKEN" ]; then
            echo "Error: VSCE_TOKEN secret is not set" >&2
            exit 1
          fi
          npx vsce publish --packagePath extension.vsix -p "$VSCE_TOKEN"
